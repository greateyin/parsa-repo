{{/*
Enhanced Vimeo Embed Shortcode with Privacy and Performance
Usage: {{< vimeo id="VIDEO_ID" title="Video Title" autoplay="false" >}}
*/}}

{{- $id := .Get "id" -}}
{{- $title := .Get "title" | default "Vimeo video" -}}
{{- $autoplay := .Get "autoplay" | default "false" -}}
{{- $class := .Get "class" -}}
{{- $privacy := site.Config.Privacy.Vimeo.EnableDNT | default true -}}

{{- if not $id -}}
  {{- errorf "Vimeo shortcode requires 'id' parameter" -}}
{{- end -}}

{{- $params := slice -}}
{{- if eq $autoplay "true" -}}
  {{- $params = $params | append "autoplay=1" -}}
{{- end -}}
{{- if $privacy -}}
  {{- $params = $params | append "dnt=1" -}}
{{- end -}}
{{- $params = $params | append "title=0" -}}
{{- $params = $params | append "byline=0" -}}
{{- $params = $params | append "portrait=0" -}}

{{- $queryString := "" -}}
{{- if $params -}}
  {{- $queryString = printf "?%s" (delimit $params "&") -}}
{{- end -}}

<div class="vimeo-embed {{ with $class }}{{ . }}{{ end }} my-8">
  <div class="relative aspect-video overflow-hidden rounded-lg bg-muted shadow-lg">
    <!-- Loading placeholder -->
    <div class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-900">
      <div class="text-center">
        <svg class="w-16 h-16 mx-auto mb-4 text-gray-400 dark:text-gray-600" fill="currentColor" viewBox="0 0 24 24">
          <path d="M23.977 6.416c-.105 2.338-1.739 5.543-4.894 9.609-3.268 4.247-6.026 6.37-8.29 6.37-1.409 0-2.578-1.294-3.553-3.881L5.322 11.4C4.603 8.816 3.834 7.522 3.01 7.522c-.179 0-.806.378-1.881 1.132L0 7.197c1.185-1.044 2.351-2.084 3.501-3.128C5.08 2.701 6.266 1.984 7.055 1.91c1.867-.18 3.016 1.1 3.447 3.838.465 2.953.789 4.789.971 5.507.539 2.45 1.131 3.674 1.776 3.674.502 0 1.256-.796 2.265-2.385 1.004-1.589 1.54-2.797 1.612-3.628.144-1.371-.395-2.061-1.614-2.061-.574 0-1.167.121-1.777.391 1.186-3.868 3.434-5.757 6.762-5.637 2.473.06 3.628 1.664 3.493 4.797l-.013.01z"/>
        </svg>
        <p class="text-sm text-gray-500 dark:text-gray-400">Loading Vimeo video...</p>
      </div>
    </div>
    
    <!-- Vimeo iframe -->
    <iframe 
      src="https://player.vimeo.com/video/{{ $id }}{{ $queryString }}"
      title="{{ $title }}"
      frameborder="0"
      allow="autoplay; fullscreen; picture-in-picture"
      allowfullscreen
      class="absolute inset-0 w-full h-full"
      loading="lazy">
    </iframe>
  </div>
  
  {{- if $title -}}
  <p class="mt-3 text-sm text-muted-foreground text-center">
    {{ $title }}
  </p>
  {{- end -}}
</div>

{{/* Add structured data for video */}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoObject",
  "name": "{{ $title }}",
  "embedUrl": "https://player.vimeo.com/video/{{ $id }}",
  "uploadDate": "{{ now.Format "2006-01-02" }}"
}
</script>