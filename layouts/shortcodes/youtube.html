{{/*
Enhanced YouTube Embed Shortcode with Privacy and Performance
Usage: {{< youtube id="VIDEO_ID" title="Video Title" autoplay="false" start="30" >}}
*/}}

{{- $id := .Get "id" -}}
{{- $title := .Get "title" | default "YouTube video" -}}
{{- $autoplay := .Get "autoplay" | default "false" -}}
{{- $start := .Get "start" -}}
{{- $class := .Get "class" -}}
{{- $privacy := .Get "privacy" | default "true" -}}

{{- if not $id -}}
  {{- errorf "YouTube shortcode requires 'id' parameter" -}}
{{- end -}}

{{- $domain := "www.youtube.com" -}}
{{- if eq $privacy "true" -}}
  {{- $domain = "www.youtube-nocookie.com" -}}
{{- end -}}

{{- $params := slice -}}
{{- if eq $autoplay "true" -}}
  {{- $params = $params | append "autoplay=1" -}}
{{- end -}}
{{- if $start -}}
  {{- $params = $params | append (printf "start=%s" $start) -}}
{{- end -}}
{{- $params = $params | append "rel=0" -}}
{{- $params = $params | append "modestbranding=1" -}}

{{- $queryString := "" -}}
{{- if $params -}}
  {{- $queryString = printf "?%s" (delimit $params "&") -}}
{{- end -}}

<div class="youtube-embed {{ with $class }}{{ . }}{{ end }} my-8">
  <div class="relative aspect-video overflow-hidden rounded-lg bg-muted shadow-lg">
    <!-- Loading placeholder -->
    <div class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-900">
      <div class="text-center">
        <svg class="w-16 h-16 mx-auto mb-4 text-gray-400 dark:text-gray-600" fill="currentColor" viewBox="0 0 24 24">
          <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
        </svg>
        <p class="text-sm text-gray-500 dark:text-gray-400">Loading YouTube video...</p>
      </div>
    </div>
    
    <!-- YouTube iframe -->
    <iframe 
      src="https://{{ $domain }}/embed/{{ $id }}{{ $queryString }}"
      title="{{ $title }}"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen
      class="absolute inset-0 w-full h-full"
      loading="lazy">
    </iframe>
  </div>
  
  {{- if $title -}}
  <p class="mt-3 text-sm text-muted-foreground text-center">
    {{ $title }}
  </p>
  {{- end -}}
</div>

{{/* Add structured data for video */}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoObject",
  "name": "{{ $title }}",
  "embedUrl": "https://{{ $domain }}/embed/{{ $id }}",
  "uploadDate": "{{ now.Format "2006-01-02" }}",
  "thumbnailUrl": "https://img.youtube.com/vi/{{ $id }}/maxresdefault.jpg"
}
</script>