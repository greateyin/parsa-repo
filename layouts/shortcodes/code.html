{{/*
Enhanced Code Block Shortcode with syntax highlighting and copy functionality
Usage: {{< code lang="javascript" title="example.js" copy="true" >}}
const hello = "world";
{{< /code >}}
*/}}

{{- $lang := .Get "lang" | default "text" -}}
{{- $title := .Get "title" -}}
{{- $copy := .Get "copy" | default "true" -}}
{{- $lineNumbers := .Get "lineNumbers" | default "false" -}}
{{- $highlight := .Get "highlight" -}}
{{- $class := .Get "class" -}}

{{- $codeId := printf "code-%d" (now.UnixNano) -}}

<div class="code-block {{ with $class }}{{ . }}{{ end }} my-6">
  {{- if or $title (eq $copy "true") -}}
  <div class="flex items-center justify-between bg-muted px-4 py-2 rounded-t-lg border-b">
    {{- if $title -}}
    <span class="text-sm font-medium text-muted-foreground">{{ $title }}</span>
    {{- else -}}
    <span class="text-sm font-medium text-muted-foreground">{{ $lang }}</span>
    {{- end -}}
    
    {{- if eq $copy "true" -}}
    <button 
      onclick="copyCode('{{ $codeId }}')"
      class="inline-flex items-center px-2 py-1 text-xs bg-background hover:bg-accent rounded border transition-colors"
      aria-label="Copy code">
      <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
      </svg>
      Copy
    </button>
    {{- end -}}
  </div>
  {{- end -}}
  
  <div class="relative">
    <pre id="{{ $codeId }}" class="overflow-x-auto p-4 bg-muted/50 {{ if or $title (eq $copy "true") }}rounded-b-lg{{ else }}rounded-lg{{ end }}"><code class="language-{{ $lang }}">{{- .Inner | htmlEscape -}}</code></pre>
  </div>
</div>

{{- if eq $copy "true" -}}
<script>
function copyCode(elementId) {
  const codeElement = document.getElementById(elementId);
  const code = codeElement.querySelector('code').textContent;
  
  navigator.clipboard.writeText(code).then(() => {
    const button = codeElement.parentElement.querySelector('button');
    const originalText = button.innerHTML;
    
    button.innerHTML = `
      <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      Copied!
    `;
    
    setTimeout(() => {
      button.innerHTML = originalText;
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy code: ', err);
  });
}
</script>
{{- end -}}