{{- /* Analytics Manager - Simplified Version for Integration Testing */ -}}

{{- /* Get configuration variables */ -}}
{{- $privacy := site.Params.privacy | default dict -}}
{{- $respectDNT := $privacy.respectDoNotTrack | default true -}}
{{- $performance := site.Params.performance | default dict -}}
{{- $asyncScripts := $performance.asyncScripts | default true -}}

{{- /* Google Analytics configuration */ -}}
{{- $gaID := site.Config.Services.GoogleAnalytics.ID -}}

{{- /* Facebook Pixel configuration */ -}}
{{- $fbPixel := site.Params.facebookPixel -}}

{{- /* Load Google Analytics (if configured) */ -}}
{{- if $gaID -}}
  {{- partial "analytics/google-analytics.html" . -}}
{{- end -}}

{{- /* Load Facebook Pixel (if configured) */ -}}
{{- if and $fbPixel.enabled $fbPixel.pixelId -}}
  {{- partial "analytics/facebook-pixel.html" . -}}
{{- end -}}

<!-- Analytics Manager JavaScript -->
<script>
  // Simple analytics manager for integration testing
  window.analyticsManager = {
    services: {
      {{- if $gaID }}
      googleAnalytics: {
        id: '{{ $gaID }}',
        enabled: true,
        loaded: false
      },
      {{- end }}
      {{- if and $fbPixel.enabled $fbPixel.pixelId }}
      facebookPixel: {
        id: '{{ $fbPixel.pixelId }}',
        enabled: true,
        loaded: false
      }
      {{- end }}
    },
    
    // Initialize analytics
    init: function() {
      console.log('Analytics Manager: Initialized');
      
      {{- if $respectDNT }}
      // Check for Do Not Track
      var dnt = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      if (dnt === "1" || dnt === "yes") {
        console.log('Analytics: Do Not Track detected, analytics disabled');
        return;
      }
      {{- end }}
      
      // Mark services as loaded when available
      this.checkServicesLoaded();
    },
    
    // Check if services are loaded
    checkServicesLoaded: function() {
      var self = this;
      
      {{- if $gaID }}
      if (typeof gtag !== 'undefined' && this.services.googleAnalytics) {
        this.services.googleAnalytics.loaded = true;
        console.log('Analytics: Google Analytics loaded');
      }
      {{- end }}
      
      {{- if and $fbPixel.enabled $fbPixel.pixelId }}
      if (typeof fbq !== 'undefined' && this.services.facebookPixel) {
        this.services.facebookPixel.loaded = true;
        console.log('Analytics: Facebook Pixel loaded');
      }
      {{- end }}
    },
    
    // Track events
    trackEvent: function(eventName, parameters) {
      {{- if $gaID }}
      if (typeof gtag !== 'undefined') {
        gtag('event', eventName, parameters || {});
      }
      {{- end }}
      
      {{- if and $fbPixel.enabled $fbPixel.pixelId }}
      if (typeof fbq !== 'undefined') {
        fbq('track', eventName, parameters || {});
      }
      {{- end }}
    }
  };
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      window.analyticsManager.init();
    });
  } else {
    window.analyticsManager.init();
  }
  
  // Check services loaded after page load
  window.addEventListener('load', function() {
    setTimeout(function() {
      window.analyticsManager.checkServicesLoaded();
    }, 1000);
  });
</script>