{{/*
  Ad Manager Partial
  
  This partial coordinates all advertising services and ad placements.
  It handles configuration-driven ad positioning, fallback handling,
  and integration with privacy settings.
  
  Parameters:
  - .position: Specific ad position to render (optional)
  - .context: Page context for ad targeting
  
  Requirements: 2.1, 2.4, 6.2
*/}}

{{- $adsense := site.Params.adsense | default dict -}}
{{- $adsenseEnabled := $adsense.enabled | default false -}}
{{- $adsenseClient := $adsense.client | default "" -}}
{{- $adsenseConfigured := and $adsenseEnabled $adsenseClient -}}
{{- $privacy := site.Params.privacy | default dict -}}
{{- $performance := site.Params.performance | default dict -}}
{{- $position := "head" -}}
{{- $context := "general" -}}
{{- if isset . "position" }}{{ $position = .position }}{{ end }}
{{- if isset . "context" }}{{ $context = .context }}{{ end }}

{{- if $adsenseConfigured -}}

{{- /* Ad placement configuration */ -}}
{{- $placements := $adsense.placements | default dict -}}

{{- /* Define ad slots for different positions */ -}}
{{- $adSlots := dict 
  "header" ($adsense.headerSlot | default $adsense.inArticleSlot)
  "sidebar" ($adsense.sidebarSlot | default $adsense.inArticleSlot)
  "footer" ($adsense.footerSlot | default $adsense.inArticleSlot)
  "inContent" ($adsense.inArticleSlot)
  "beforeContent" ($adsense.beforeContentSlot | default $adsense.inArticleSlot)
  "afterContent" ($adsense.afterContentSlot | default $adsense.inArticleSlot)
-}}

{{- /* Render specific position or all enabled positions */ -}}
{{- if $position -}}
  {{- /* Render single position */ -}}
  {{- $enabled := index $placements $position -}}
  {{- $slot := index $adSlots $position -}}
  
  {{- if and $enabled $slot -}}
    {{- $adConfig := dict 
      "slot" $slot
      "position" $position
      "class" (printf "ad-%s" $position)
      "lazy" (and ($performance.lazyLoadAds | default true) (ne $position "header"))
    -}}
    
    {{- partial "advertising/adsense-display.html" $adConfig -}}
  {{- end -}}
  
{{- else -}}
  {{- /* Include lazy ad loader */ -}}
  {{- if $performance.lazyLoadAds | default true -}}
    {{- partial "performance/lazy-ad-loader.html" . -}}
  {{- end -}}
  
  {{- /* Initialize ad management system */ -}}
  <script>
    // Initialize AdSense Ad Manager
    window.AdSenseManager = window.AdSenseManager || {
      config: {
        client: '{{ $adsenseClient }}',
        autoAds: {{ $adsense.autoAds | default false }},
        lazyLoad: {{ $performance.lazyLoadAds | default true }},
        respectDNT: {{ $privacy.respectDoNotTrack | default false }}
      },
      placements: {{ $placements | jsonify }},
      slots: {{ $adSlots | jsonify }},
      initialized: false,
      
      // Initialize the ad manager
      init: function() {
        if (this.initialized) return;
        
        {{- if $privacy.respectDoNotTrack -}}
        // Check Do Not Track preference
        var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
        var doNotTrack = (dnt == "1" || dnt == "yes");
        
        if (doNotTrack) {
          console.log('AdSense: Disabled due to Do Not Track preference');
          this.hideAllAds();
          return;
        }
        {{- end -}}
        
        {{- if $privacy.cookieConsent -}}
        // Check cookie consent
        if (typeof window.ThemePrivacy !== 'undefined' && !window.ThemePrivacy.canShowAds()) {
          console.log('AdSense: Disabled due to privacy settings');
          this.hideAllAds();
          return;
        }
        {{- end -}}
        
        this.initialized = true;
        this.setupErrorHandling();
        this.trackAdPerformance();
        
        console.log('AdSense Manager initialized with', Object.keys(this.placements).length, 'placement configurations');
      },
      
      // Hide all ads when disabled
      hideAllAds: function() {
        var adContainers = document.querySelectorAll('.ad-container');
        adContainers.forEach(function(container) {
          container.style.display = 'none';
        });
      },
      
      // Setup error handling for ads
      setupErrorHandling: function() {
        var self = this;
        
        // Monitor AdSense errors
        window.addEventListener('error', function(e) {
          if (e.target && e.target.src && e.target.src.includes('googlesyndication.com')) {
            console.warn('AdSense script error:', e.target.src);
            
            // Track error in analytics
            if (typeof gtag !== 'undefined') {
              gtag('event', 'adsense_error', {
                'error_type': 'script_load',
                'error_message': e.message || 'Script load failure'
              });
            }
          }
        });
        
        // Monitor ad blocking
        setTimeout(function() {
          if (typeof adsbygoogle === 'undefined' || !window.adsbygoogle) {
            console.warn('AdSense may be blocked by ad blocker');
            
            if (typeof gtag !== 'undefined') {
              gtag('event', 'adsense_blocked', {
                'block_type': 'script_unavailable'
              });
            }
          }
        }, 3000);
      },
      
      // Track ad performance
      trackAdPerformance: function() {
        if (typeof gtag === 'undefined') return;
        
        // Track ad manager initialization
        gtag('event', 'adsense_manager_init', {
          'placements_count': Object.keys(this.placements).length,
          'auto_ads': this.config.autoAds,
          'lazy_load': this.config.lazyLoad
        });
      },
      
      // Mark script as loaded (called by AsyncScriptLoader)
      markScriptLoaded: function() {
        console.log('AdSense: Script loaded successfully');
        
        // Initialize lazy loading if available
        if (window.LazyAdLoader) {
          window.LazyAdLoader.registerLazyAds();
        }
      },
      
      // Refresh ads (for SPA navigation)
      refresh: function() {
        if (!this.initialized) return;
        
        try {
          if (window.adsbygoogle) {
            window.adsbygoogle.forEach(function(ad) {
              if (ad && typeof ad.refresh === 'function') {
                ad.refresh();
              }
            });
          }
        } catch (e) {
          console.warn('AdSense refresh failed:', e);
        }
      }
    };
    
    // Auto-initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        window.AdSenseManager.init();
      });
    } else {
      window.AdSenseManager.init();
    }
    
    // Handle page navigation for SPA
    window.addEventListener('popstate', function() {
      if (window.AdSenseManager) {
        window.AdSenseManager.refresh();
      }
    });
  </script>
  
  {{- /* Render ads for enabled positions */ -}}
  {{- range $pos, $enabled := $placements -}}
    {{- if $enabled -}}
      {{- $slot := index $adSlots $pos -}}
      {{- if $slot -}}
        {{- $adConfig := dict 
          "slot" $slot
          "position" $pos
          "class" (printf "ad-%s" $pos)
          "lazy" (and ($performance.lazyLoadAds | default true) (ne $pos "header"))
        -}}
        
        <div class="ad-position ad-position-{{ $pos }}" data-ad-position="{{ $pos }}">
          {{- partial "advertising/adsense-display.html" $adConfig -}}
        </div>
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
{{- end -}}

{{- else -}}
  {{- /* Fallback when AdSense is disabled */ -}}
  {{- if hugo.IsServer -}}
  <div class="ad-manager-disabled">
    <!-- AdSense Ad Manager: Disabled (adsense.enabled = {{ $adsenseEnabled }}, client configured = {{ if $adsenseClient }}true{{ else }}false{{ end }}) -->
  </div>
  {{- end -}}
{{- end -}}