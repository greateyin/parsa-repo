{{- /* Analytics Manager - Coordinates all tracking services */ -}}
{{- /* Requirements: 1.1, 8.2, 8.5 */ -}}

{{- $privacy := site.Params.privacy | default dict -}}
{{- $performance := site.Params.performance | default dict -}}
{{- $respectDNT := $privacy.respectDoNotTrack | default true -}}
{{- $asyncScripts := $performance.asyncScripts | default true -}}

{{- /* Check for Do Not Track globally */ -}}
{{- if $respectDNT -}}
<script>
  // Global Do Not Track detection
  window.analyticsConfig = window.analyticsConfig || {};
  var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
  window.analyticsConfig.doNotTrack = (dnt == "1" || dnt == "yes");
  window.analyticsConfig.respectDNT = {{ $respectDNT }};
</script>
{{- end -}}

{{- /* Performance optimization: Use async script loader */ -}}
{{- if $asyncScripts -}}
  {{- partial "performance/async-script-loader.html" . -}}
{{- end -}}

{{- /* Include performance monitoring */ -}}
{{- if $performance.monitoring.enabled | default true -}}
  {{- partial "performance/performance-monitor.html" . -}}
{{- end -}}

{{- /* Load Google Analytics 4 */ -}}
{{- $ga := site.Config.Services.GoogleAnalytics -}}
{{- $gaID := $ga.ID | default site.GoogleAnalyticsID -}}
{{- if $gaID -}}
  {{- partial "analytics/google-analytics.html" . -}}
{{- end -}}

{{- /* Load Facebook Pixel (if configured) */ -}}
{{- $fbPixel := site.Params.facebookPixel | default dict -}}
{{- $fbPixelEnabled := $fbPixel.enabled | default false -}}
{{- $fbPixelId := $fbPixel.pixelId | default "" -}}
{{- $fbPixelConfigured := and $fbPixelEnabled $fbPixelId -}}
{{- $fbPixelEvents := $fbPixel.events | default dict -}}
{{- if $fbPixelConfigured -}}
  {{- partial "analytics/facebook-pixel.html" . -}}
{{- end -}}

{{- /* Analytics coordination script */ -}}
<script>
  // Analytics Manager - Coordinates tracking services
  window.analyticsManager = {
    services: {
      {{- if $gaID }}
      googleAnalytics: {
        id: '{{ $gaID }}',
        enabled: true,
        loaded: false
      },
      {{- end }}
      {{- if $fbPixelConfigured }}
      facebookPixel: {
        id: '{{ $fbPixelId }}',
        enabled: true,
        loaded: false,
        events: {
          {{- if $fbPixel.events }}
          pageView: {{ $fbPixelEvents.pageView | default true }},
          viewContent: {{ $fbPixelEvents.viewContent | default false }},
          search: {{ $fbPixelEvents.search | default false }},
          contact: {{ $fbPixelEvents.contact | default false }},
          lead: {{ $fbPixelEvents.lead | default false }},
          outboundClick: {{ $fbPixelEvents.outboundClick | default false }}
          {{- else }}
          pageView: true,
          viewContent: false,
          search: false,
          contact: false,
          lead: false,
          outboundClick: false
          {{- end }}
        }
      },
      {{- end }}
    },
    
    // Track service loading status
    markServiceLoaded: function(service) {
      if (this.services[service]) {
        this.services[service].loaded = true;
        console.log('Analytics: ' + service + ' loaded successfully');
      }
    },
    
    // Get loading status
    getLoadingStatus: function() {
      var status = {};
      for (var service in this.services) {
        status[service] = this.services[service].loaded;
      }
      return status;
    },
    
    // Privacy-compliant event tracking
    trackEvent: function(eventName, parameters, service) {
      {{- if $respectDNT }}
      if (window.analyticsConfig && window.analyticsConfig.doNotTrack) {
        console.log('Analytics: Event tracking disabled due to Do Not Track');
        return;
      }
      {{- end }}
      
      parameters = parameters || {};
      
      // Route to appropriate service
      if (!service || service === 'googleAnalytics') {
        {{- if $gaID }}
        if (typeof gtag !== 'undefined') {
          gtag('event', eventName, parameters);
        }
        {{- end }}
      }
      
      if (!service || service === 'facebookPixel') {
        {{- if $fbPixelConfigured }}
        if (typeof fbq !== 'undefined') {
          fbq('track', eventName, parameters);
        }
        {{- end }}
      }
    },
    
    // Facebook Pixel specific event tracking
    facebookPixel: {
      {{- if $fbPixelConfigured }}
      // Standard events
      trackPageView: function() {
        {{- if $fbPixelEvents.pageView | default true }}
        if (typeof fbq !== 'undefined') {
          fbq('track', 'PageView');
        }
        {{- end }}
      },

      trackViewContent: function(contentData) {
        {{- if $fbPixelEvents.viewContent }}
        if (typeof fbq !== 'undefined') {
          var data = contentData || {
            content_type: 'article',
            content_ids: [window.location.href],
            content_name: document.title
          };
          fbq('track', 'ViewContent', data);
        }
        {{- end }}
      },

      trackSearch: function(searchTerm) {
        {{- if $fbPixelEvents.search }}
        if (typeof fbq !== 'undefined' && searchTerm) {
          fbq('track', 'Search', {
            search_string: searchTerm
          });
        }
        {{- end }}
      },
      
      trackContact: function() {
        {{- if $fbPixelEvents.contact }}
        if (typeof fbq !== 'undefined') {
          fbq('track', 'Contact');
        }
        {{- end }}
      },

      trackLead: function() {
        {{- if $fbPixelEvents.lead }}
        if (typeof fbq !== 'undefined') {
          fbq('track', 'Lead');
        }
        {{- end }}
      },
      
      // Custom event tracking
      trackCustomEvent: function(eventName, eventData) {
        if (typeof fbq !== 'undefined' && eventName) {
          fbq('trackCustom', eventName, eventData || {});
        }
      }
      {{- else }}
      // Facebook Pixel not configured
      trackPageView: function() { console.log('Facebook Pixel: Not configured'); },
      trackViewContent: function() { console.log('Facebook Pixel: Not configured'); },
      trackSearch: function() { console.log('Facebook Pixel: Not configured'); },
      trackContact: function() { console.log('Facebook Pixel: Not configured'); },
      trackLead: function() { console.log('Facebook Pixel: Not configured'); },
      trackCustomEvent: function() { console.log('Facebook Pixel: Not configured'); }
      {{- end }}
    },
    
    // Page interaction tracking
    trackPageInteractions: function() {
      var self = this;
      
      // Track scroll depth for Facebook Pixel
      {{- if and $fbPixelConfigured ($fbPixelEvents.viewContent | default false) }}
      var scrollTracked = false;
      window.addEventListener('scroll', function() {
        if (!scrollTracked && (window.scrollY / document.body.scrollHeight) > 0.5) {
          scrollTracked = true;
          self.facebookPixel.trackCustomEvent('ScrollDepth50');
        }
      });
      {{- end }}
      
      // Track outbound link clicks
      document.addEventListener('click', function(e) {
        var link = e.target.closest('a');
        if (link && link.hostname !== window.location.hostname) {
          {{- if $fbPixelEvents.outboundClick | default false }}
          self.facebookPixel.trackCustomEvent('OutboundClick', {
            url: link.href,
            text: link.textContent.trim()
          });
          {{- end }}
        }
      });
      
      // Track form submissions
      document.addEventListener('submit', function(e) {
        var form = e.target;
        if (form.tagName === 'FORM') {
          {{- if $fbPixelEvents.contact }}
          if (form.classList.contains('contact-form') || form.id.includes('contact')) {
            self.facebookPixel.trackContact();
          }
          {{- end }}
          
          {{- if $fbPixelEvents.lead }}
          if (form.classList.contains('newsletter-form') || form.classList.contains('subscribe-form')) {
            self.facebookPixel.trackLead();
          }
          {{- end }}
        }
      });
    },
    
    // Performance monitoring
    performance: {
      startTime: performance.now(),
      
      measureLoadTime: function() {
        var loadTime = performance.now() - this.startTime;
        console.log('Analytics: Total load time: ' + Math.round(loadTime) + 'ms');
        
        {{- if $gaID }}
        if (typeof gtag !== 'undefined') {
          gtag('event', 'timing_complete', {
            'name': 'analytics_load',
            'value': Math.round(loadTime)
          });
        }
        {{- end }}
      }
    }
  };
  
  // Measure performance when page is fully loaded
  {{- if $performance.measurePerformance | default false }}
  window.addEventListener('load', function() {
    setTimeout(function() {
      window.analyticsManager.performance.measureLoadTime();
    }, 100);
  });
  {{- end }}
  
  // Mark Google Analytics as loaded when available
  {{- if $gaID }}
  window.addEventListener('load', function() {
    if (typeof gtag !== 'undefined') {
      window.analyticsManager.markServiceLoaded('googleAnalytics');
    }
  });
  {{- end }}
  
  // Mark Facebook Pixel as loaded when available
  {{- if $fbPixelConfigured }}
  window.addEventListener('load', function() {
    if (typeof fbq !== 'undefined') {
      window.analyticsManager.markServiceLoaded('facebookPixel');
      // Initialize page interaction tracking
      window.analyticsManager.trackPageInteractions();
    }
  });
  {{- end }}
</script>

{{- /* Error handling for failed script loads */ -}}
<script>
  // Global error handler for analytics scripts
  window.addEventListener('error', function(e) {
    if (e.filename && (
      e.filename.includes('googletagmanager.com') ||
      e.filename.includes('connect.facebook.net')
    )) {
      console.warn('Analytics: Failed to load external script:', e.filename);
      
      // Track script loading failures
      {{- if $gaID }}
      if (typeof gtag !== 'undefined') {
        gtag('event', 'exception', {
          'description': 'Analytics script load failure: ' + e.filename,
          'fatal': false
        });
      }
      {{- end }}
    }
  });
  
  // Expose Facebook Pixel tracking functions globally for easy access
  {{- if $fbPixelConfigured }}
  window.fbPixelTrackSearch = function(searchTerm) {
    window.analyticsManager.facebookPixel.trackSearch(searchTerm);
  };
  
  window.fbPixelTrackContact = function() {
    window.analyticsManager.facebookPixel.trackContact();
  };
  
  window.fbPixelTrackLead = function() {
    window.analyticsManager.facebookPixel.trackLead();
  };
  
  window.fbPixelTrackCustom = function(eventName, eventData) {
    window.analyticsManager.facebookPixel.trackCustomEvent(eventName, eventData);
  };
  {{- end }}
</script>